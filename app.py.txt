import streamlit as st
import pandas as pd
from sqlalchemy import create_engine
import plotly.express as px

# Streamlit config FIRST
st.set_page_config(layout="wide", page_title="PhonePe Pulse Dashboard")
st.title("ðŸ“± PhonePe Pulse â€” Transaction & User Insights")

# Database connection
DB_URL = "mysql+pymysql://root:Admin%40123@localhost:3306/phonepe_db"
engine = create_engine(DB_URL)

# Test connection
try:
    test_df = pd.read_sql("SELECT COUNT(*) as rows FROM aggregated_transaction", engine)
    st.sidebar.success(f"DB Connected âœ… Rows: {test_df['rows'][0]}")
except Exception as e:
    st.sidebar.error(f"Database Error: {e}")
    st.stop()

# Sidebar Filters
with st.sidebar:
    st.header("Filters")
    states = pd.read_sql(
        "SELECT DISTINCT state FROM aggregated_transaction ORDER BY state;",
        engine
    )['state'].dropna().tolist()
    
    states.insert(0, "All India")

    sel_state = st.selectbox("Select State", states)
    metric_map = {"transaction_amount": "total_amount", "transaction_count": "total_count"}
    sel_metric = st.selectbox("Metric", list(metric_map.keys()))
    
    top_n = st.slider("Top N", 5, 50, 10)

order_column = metric_map[sel_metric]

# Top States View
st.subheader("Top States Overview")

if sel_state == "All India":
    query_top = f"""
        SELECT state,
               SUM(transaction_amount) AS total_amount,
               SUM(transaction_count) AS total_count
        FROM aggregated_transaction
        GROUP BY state
        ORDER BY {order_column} DESC
        LIMIT {top_n};
    """
    df_top = pd.read_sql(query_top, engine)
    fig = px.bar(
        df_top, x="state", y=order_column,
        title=f"Top {top_n} States by {sel_metric.replace('_',' ').title()}"
    )
    st.plotly_chart(fig, use_container_width=True)
else:
    query_trend = f"""
        SELECT year, quarter,
               SUM(transaction_amount) AS total_amount,
               SUM(transaction_count) AS total_count
        FROM aggregated_transaction
        WHERE state=%s
        GROUP BY year, quarter
        ORDER BY year, quarter;
    """
    df_trend = pd.read_sql(query_trend, engine, params=[sel_state])
    df_trend["period"] = df_trend["year"].astype(str) + " Q" + df_trend["quarter"].astype(str)
    fig = px.line(
        df_trend, x="period", y=order_column, markers=True,
        title=f"{sel_state} Quarterly Trend"
    )
    st.plotly_chart(fig, use_container_width=True)





st.markdown("---")
st.caption("Data Source: PhonePe Pulse â€¢ MySQL + SQLAlchemy + Streamlit")
